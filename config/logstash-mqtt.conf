# Logstash Pipeline: MQTT â†’ Elasticsearch
# Consumes IoT sensor data from MQTT broker

input {
  # MQTT Input Plugin
  mqtt {
    host => "broker.hivemq.com"
    port => 1883
    topic => "iot/sensors/#"
    client_id => "logstash_consumer"
    codec => json
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }
  
  # Add metadata
  mutate {
    add_field => {
      "data_source" => "mqtt"
      "pipeline" => "iot-logging"
    }
  }
  
  # Categorize by sensor type
  if [sensor_type] == "temperature" {
    mutate {
      add_tag => ["temperature", "environmental"]
    }
  } else if [sensor_type] == "humidity" {
    mutate {
      add_tag => ["humidity", "environmental"]
    }
  } else if [sensor_type] == "motion" {
    mutate {
      add_tag => ["motion", "security"]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["https://my-elasticsearch-project-a9ce97.es.asia-south1.gcp.elastic.cloud:443"]
    api_key => "aWpab0hwb0JGN000SUpSOUJBbzM6YUJKNldWUW16UkU2SHJHbnJ2LVR4Zw=="
    index => "iot-logs-%{+YYYY.MM.dd}"
    
    # Optional: Use ILM for index management
    ilm_enabled => true
    ilm_rollover_alias => "iot-logs"
  }
  
  # Debug output (optional)
  stdout {
    codec => rubydebug
  }
}